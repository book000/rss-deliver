# Claude Code 作業方針

## 目的

このファイルは Claude Code の作業方針とプロジェクト固有ルールを示します。

## 判断記録のルール

すべての判断は以下の形式で記録してください：

1. **判断内容の要約**: 何を決定したか
2. **検討した代替案**: 他にどのような選択肢があったか
3. **採用しなかった案とその理由**: なぜその案を採用しなかったか
4. **前提条件・仮定・不確実性**: 判断の前提となる条件や不確実性
5. **他エージェントによるレビュー可否**: 他のエージェント（Codex、Gemini）にレビューを依頼すべきか

**重要**: 前提・仮定・不確実性を明示すること。仮定を事実のように扱ってはなりません。

## プロジェクト概要

- **目的**: 複数のサービス（Zenn、FF14 Lodestone、LettuceClub など）から情報を収集し、RSS フィードを生成・配信する
- **主な機能**:
  - RSS フィード収集と生成
  - 削除された記事の追跡
  - HTML リストページの生成

## 重要ルール

### 言語使用ルール

- **会話言語**: 日本語
- **コード内コメント**: 日本語
- **エラーメッセージ**: 英語
- **日本語と英数字の間**: 半角スペースを挿入

### コミット・PR ルール

- **コミットメッセージ**: [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に従う
  - `<type>(<scope>): <description>` 形式
  - `<description>` は日本語で記載
  - 例: `feat(rss): Zenn フィード収集機能を追加`
- **ブランチ命名**: [Conventional Branch](https://conventional-branch.github.io) に従う
  - `<type>/<description>` 形式
  - `<type>` は短縮形（feat, fix）を使用
  - 例: `feat/add-zenn-feed`

## 環境のルール

- **Git コミット**: Conventional Commits に従う（`<description>` は日本語）
- **ブランチ命名**: Conventional Branch に従う（短縮形を使用）
- **GitHub リポジトリ調査**: テンポラリディレクトリに `git clone` してコード検索
- **Renovate PR**: 既存のプルリクエストに対して追加コミットや更新を行わない

## コード改修時のルール

- **日本語と英数字の間隔**: 半角スペースを挿入する
- **エラーメッセージの絵文字**: 既存のエラーメッセージに絵文字がある場合、全体で統一する
- **TypeScript**: `skipLibCheck` を有効にして回避することは禁止
- **docstring**: 関数やインターフェースには日本語で docstring (JSDoc など) を記載・更新する

## 相談ルール

### Codex CLI (ask-codex)

以下の場合に相談：
- 実装コードに対するソースコードレビュー
- 関数設計、モジュール内部の実装方針などの局所的な技術判断
- アーキテクチャ、モジュール間契約、パフォーマンス／セキュリティといった全体影響の判断
- 実装の正当性確認、機械的ミスの検出、既存コードとの整合性確認

### Gemini CLI (ask-gemini)

以下の場合に相談：
- SaaS 仕様、言語・ランタイムのバージョン差、料金・制限・クォータといった最新の適切な情報が必要な外部依存の判断
- 外部一次情報の確認、最新仕様の調査、外部前提条件の検証

### 指摘への対応ルール

他エージェントが指摘・異議を提示した場合、必ず以下のいずれかを行う。**黙殺・無言での不採用は禁止**。

- 指摘を受け入れ、判断を修正する
- 指摘を退け、その理由を明示する

以下は必ず実施してください：
- 他エージェントの提案を鵜呑みにせず、その根拠や理由を理解する
- 自身の分析結果と他エージェントの意見が異なる場合は、双方の視点を比較検討する
- 最終的な判断は、両者の意見を総合的に評価した上で、自身で下す

## 開発コマンド

```bash
# 依存関係のインストール
pnpm install

# 本番実行
pnpm start

# 開発モード（ファイル監視）
pnpm dev

# リント実行
pnpm lint

# リント自動修正
pnpm fix

# TypeScript 型チェック
pnpm lint:tsc

# ESLint チェック
pnpm lint:eslint

# Prettier チェック
pnpm lint:prettier

# ESLint 自動修正
pnpm fix:eslint

# Prettier 自動修正
pnpm fix:prettier
```

## アーキテクチャと主要ファイル

### ディレクトリ構成

```
src/
├── main.ts                   # メインエントリーポイント
├── base-service.ts          # ベースサービスクラス
├── types.d.ts               # 型定義
├── model/                   # データモデル
│   ├── collect-result.ts    # 収集結果モデル
│   ├── deleted-article.ts   # 削除記事モデル
│   └── service-information.ts # サービス情報モデル
├── services/                # RSS サービス実装
│   ├── zenn-changelog.ts    # Zenn変更履歴
│   ├── ff14-lodestone-*.ts  # FF14関連
│   └── ...                  # その他のサービス
└── utils/                   # ユーティリティ
    ├── previous-feed.ts     # 前回フィード管理
    └── deleted-articles-tracker.ts # 削除記事追跡
```

### 主要コンポーネント

- **BaseService**: すべての RSS サービスが継承するベースクラス
- **サービス実装**: 各サービス固有の RSS 収集ロジック
- **削除記事追跡**: フィード間の差分を検出し、削除された記事を記録
- **フィード生成**: XML 形式の RSS フィードを生成

## 実装パターン

### 推奨パターン

- 新しい RSS サービスは `BaseService` クラスを継承する
- 非同期処理は `async/await` を使用する
- エラーハンドリングは統一されたパターンを使用する
- ログ出力は `@book000/node-utils` の Logger を使用する
- 型定義は明示的に記述し、`any` 型の使用は避ける

### 非推奨パターン

- コールバック関数（Promise または async/await を使用）
- グローバル変数の使用
- エラーの無視（必ず適切にハンドリングする）

## テスト

### テスト方針

- 現在、このプロジェクトには自動テストが実装されていません
- 手動でのテストが必要です
- 新機能追加時は、既存機能に影響がないことを確認してください

### テスト手順

1. `pnpm start` でアプリケーションを実行
2. `output/` ディレクトリに RSS フィードが生成されることを確認
3. 各サービスのフィードが正しく取得できることを確認
4. エラーログが出力されていないことを確認

## ドキュメント更新ルール

### 更新対象

以下のファイルは変更内容に応じて更新が必要：

- `.github/copilot-instructions.md`: GitHub Copilot 向けの指示
- `CLAUDE.md`: Claude Code 向けの作業方針（このファイル）
- `AGENTS.md`: 一般的な AI エージェント向けの基本方針
- `GEMINI.md`: Gemini CLI 向けのコンテキスト

### 更新タイミング

- 新しい技術スタックを導入した時
- 開発コマンドを変更した時
- プロジェクト固有のルールを追加・変更した時

## 作業チェックリスト

### 新規改修時

1. ✅ プロジェクトについて詳細に探索し理解する
2. ✅ 作業を行うブランチが適切であることを確認する（すでに PR を提出しクローズされたブランチでないこと）
3. ✅ 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. ✅ PR がクローズされ、不要となったブランチは削除されていることを確認する
5. ✅ プロジェクトで指定されたパッケージマネージャ（pnpm）により、依存パッケージをインストールする

### コミット・プッシュする前

1. ✅ コミットメッセージが Conventional Commits に従っていること（`<description>` は日本語）
2. ✅ コミット内容にセンシティブな情報が含まれていないこと
3. ✅ Lint / Format エラーが発生しないこと（`pnpm lint` で確認）
4. ✅ 動作確認を行い、期待通り動作すること

### プルリクエストを作成する前

1. ✅ プルリクエストの作成をユーザーから依頼されていること
2. ✅ コミット内容にセンシティブな情報が含まれていないこと
3. ✅ コンフリクトする恐れが無いこと

### プルリクエストを作成したあと

以下を必ず実施する。時間がかかる処理が多いため、Task を使って並列実行すること。

1. ✅ コンフリクトが発生していないこと
2. ✅ PR 本文の内容は、ブランチの現在の状態を、今までのこの PR での更新履歴を含むことなく、最新の状態のみ、漏れなく日本語で記載されていること
3. ✅ `gh pr checks <PR ID> --watch` で GitHub Actions CI を待ち、その結果がエラーとなっていないこと。成功している場合でも、ログを確認し、誤って成功扱いになっていないこと
4. ✅ `request-review-copilot` コマンドが存在する場合、`request-review-copilot https://github.com/$OWNER/$REPO/pull/$PR_NUMBER` で GitHub Copilot へレビューを依頼すること
5. ✅ 10 分以内に投稿される GitHub Copilot レビューへの対応を行うこと。対応したら、レビューコメントそれぞれに対して返信を行うこと
6. ✅ `/code-review:code-review` によるコードレビューを実施したこと。信頼度スコアが 50 以上の指摘事項に対して対応する

## リポジトリ固有

### デプロイ

- このプロジェクトは定期的に GitHub Actions で実行されます
- RSS フィードは `output/` ディレクトリに生成されます
- GitHub Pages などでホスティングされる可能性があります

### セキュリティ

- API キーや認証情報が必要なサービスはありません
- 公開 RSS フィードのみを収集します
- ログに個人情報や機密情報を出力しないでください

### 制約事項

- Node.js のバージョンは `.node-version` ファイルで管理されています
- パッケージマネージャーは pnpm のみを使用してください
- canvas、sharp などのネイティブモジュールを使用しています
